-include ../Makefile

export PATH := $(PATH):$(abspath ./utils)

# Sanity check
ifeq ($(wildcard $(NPC_HOME)/sim/npc-main.c),)
  $(error NPC_HOME=$(NPC_HOME) is not a NPC repo)
endif

# Include variables and rules generated by menuconfig
include $(NEMU_HOME)/include/config/auto.conf
include $(NEMU_HOME)/include/config/auto.conf.cmd

# include $(AM_HOME)/Makefile
# LINKAGE += $(ARCHIVES)

remove_quote = $(patsubst "%",%,$(1))

BUILD_DIR = ./build
DIR_OBJ   = $(BUILD_DIR)/obj_dir

# Extract variabls from menuconfig
NPC_GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))
NPC_ENGINE    ?= $(call remove_quote,$(CONFIG_ENGINE))
NPC_NAME       = $(NPC_GUEST_ISA)-npc-$(NPC_ENGINE)

# Extract compiler and options from menuconfig
CC = $(call remove_quote,$(CONFIG_CC))
CFLAGS_BUILD += $(call remove_quote,$(CONFIG_CC_OPT))
CFLAGS_BUILD += $(if $(CONFIG_CC_LTO),-flto,)
CFLAGS_BUILD += $(if $(CONFIG_CC_DEBUG),-Og -ggdb3,)
CFLAGS_BUILD += $(if $(CONFIG_CC_ASAN),-fsanitize=address,)
CFLAGS_TRACE += -DITRACE_COND=$(if $(CONFIG_ITRACE_COND),$(call remove_quote,$(CONFIG_ITRACE_COND)),true)
CFLAGS_TRACE += -DIRINGBUF_COND=$(if $(CONFIG_IRINGBUF_COND),$(call remove_quote,$(CONFIG_IRINGBUF_COND)),true)
CFLAGS_TRACE += -DMTRACE_COND=$(if $(CONFIG_MTRACE_COND),$(call remove_quote,$(CONFIG_MTRACE_COND)),true)
CFLAGS_TRACE += -DFTRACE_COND=$(if $(CONFIG_FTRACE_COND),$(call remove_quote,$(CONFIG_FTRACE_COND)),true)
CFLAGS  += $(CFLAGS_BUILD) $(CFLAGS_TRACE) -D__GUEST_ISA__=$(NPC_GUEST_ISA) $(INCFLAGS) \
		   $(shell llvm-config --cxxflags) -fPIE
LDFLAGS += $(CFLAGS_BUILD)               \
           -lreadline -ldl -pie          \
           -rdynamic                     \
           $(shell llvm-config --libs) \
           -lSDL2
 # -fsanitize=address			\

# scala_src
DIRS = $(abspath $(NPC_HOME)/cpu)
SRCS = $(shell find $(DIRS) -name "*.scala")

#SOC
YSYXSoC = ../ysyxSoC

# verilog_src
TOP_NAME = ysyxSoCFull

BIN      = $(BUILD_DIR)/$(TOP_NAME)

MCR_NAME = ysyx_23060250
SRCV_GEN = $(BUILD_DIR)/$(MCR_NAME).v
# VSRCS += SRCV_GEN
VSRCS += $(shell find $(abspath $(YSYXSoC)/perip) -name "*.v")
VSRCS += $(shell find $(abspath $(YSYXSoC)/build) -name "*.v")

# include
DIRI  = $(NPC_HOME)/include           	\
		$(NPC_HOME)/include/generated 	\
		$(NPC_HOME)/build/obj_dir		\
		$(NPC_HOME)/sim/riscv32/include
INCS  = $(shell find $(DIRI) -name "*.h")
INCFLAGS = $(addprefix -I, $(DIRI))

# c_src
DIRC += $(NPC_HOME)/sim             \
        $(NPC_HOME)/sim/cpu         \
        $(NPC_HOME)/sim/riscv32     \
        $(NPC_HOME)/sim/memory      \
        $(NPC_HOME)/sim/monitor     \
        $(NPC_HOME)/sim/monitor/sdb \
        $(NPC_HOME)/sim/device/io   \
        $(NPC_HOME)/sim/utils		\
		$(NPC_HOME)/sim/engine      \
		$(NPC_HOME)/sim/engine/interpreter \
		$(NPC_HOME)/cpu/resources
SRCC  = $(shell find $(DIRC) -name "*.c") \
		$(NPC_HOME)/sim/utils/disasm.cpp \
		$(NPC_HOME)/sim/dpic.cpp

$(SRCV_GEN): $(SRCS)
	$(call git_commit, "generate verilog")
	mkdir -p $(BUILD_DIR)                           
	mill -i __.test.runMain Elaborate --target-dir $(BUILD_DIR)
	@sed -i '/\/\/ ----- 8< ----- FILE "firrtl_black_box_resource_files.f" ----- 8< -----/,$$d' $@

# BIN      = $(BUILD_DIR)/$(NPC_NAME)

VERILATOR         = verilator
VERILATOR_INC     = -I$(YSYXSoC)/perip/uart16550/rtl -I$(YSYXSoC)/perip/spi/rtl
VERILATOR_CFLAGS += -MMD --build -cc -O3 --trace
VERILATOR_CFLAGS += $(VERILATOR_INC)
VERILATOR_CFLAGS += --timescale "1ns/1ns" --no-timing
VERILATOR_CFLAGS += --autoflush

$(BIN): $(VSRCS) $(SRCV_GEN) $(SRCC)
	@rm -rf $(DIR_OBJ)
	$(VERILATOR) $(VERILATOR_CFLAGS)        \
	--top-module $(TOP_NAME) $(VSRCS) $(SRCV_GEN) $(SRCC) \
	$(addprefix -CFLAGS ,  $(CFLAGS))           \
	$(addprefix -LDFLAGS , $(LDFLAGS))          \
	--Mdir $(DIR_OBJ) --exe -o $(abspath $(BIN))


override ARGS ?= --log=$(BUILD_DIR)/npc-log.txt
override ARGS += --diff=$(NEMU_HOME)/build/riscv32-nemu-interpreter-so 
IMG ?=
NPC_EXEC := $(BIN) $(ARGS) $(IMG)

run: $(BIN) $(DIFF_REF_SO)
	$(call git_commit, "run NPC")
	$(NPC_EXEC)

test:
	mill -i __.test

verilog: $(SRCV_GEN)
	$(call git_commit, "generate verilog")
	mkdir -p $(BUILD_DIR)
	mill -i __.test.runMain Elaborate $(BUILD_DIR)

help:
	mill -i __.test.runMain Elaborate --help

compile:
	mill -i __.compile

bsp:
	mill -i mill.bsp.BSP/install

reformat:
	mill -i __.reformat

checkformat:
	mill -i __.checkFormat

clean:
	-rm -rf $(BUILD_DIR)

.PHONY: test verilog help compile bsp reformat checkformat clean

sim:
	$(call git_commit, "sim RTL") # DO NOT REMOVE THIS LINE!!!
	@echo "Write this Makefile by yourself."